<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">

  <title>Resource Registry Demystified</title>

  <meta name="description" content="Resource Registry Demystified - Plone Conference 2017">
  <meta name="author" content="Johannes Raggam, programmatic">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css?family=Ubuntu" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/3.5.0/css/reveal.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/3.5.0/css/theme/simple.css" rel="stylesheet">
  <!--link href="./resources/libs/reveal.js/css/reveal.css" rel="stylesheet">
  <link href="./resources/libs/reveal.js/css/theme/simple.css" rel="stylesheet"-->
  <link href="./resources/highlightjs-github.css" rel="stylesheet">
  <link href="./resources/custom.css" rel="stylesheet">
  <script>
    if( window.location.search.match( /print-pdf/gi ) ) {
      var link = document.createElement( 'link' );
      link.rel = 'stylesheet';
      link.type = 'text/css';
      link.href = 'https://cdnjs.cloudflare.com/ajax/libs/reveal.js/3.5.0/css/print/pdf.css';
      //link.href = './resources/libs/reveal.js/3.5.0/css/print/pdf.css';
      document.getElementsByTagName( 'head' )[0].appendChild( link );
    }
  </script>
</head>

<body>
    <!--
blue
#0083BE
green
#0BD52D
yellow
#CBBE00
red
#CB4B0A
#ED0200
#0B934A
#B35725
#7E231D

colors:
https://kuler.adobe.com/create/color-wheel/?base=2&rule=Analogous&selected=4&name=My%20Kuler%20Theme&mode=rgb&rgbvalues=0.7950980392156863,0.21951409859249027,0,0.5686743281526693,0.018820642827770902,0.8350980392156863,0,0.5137254901960784,0.7450980392156863,0.14597107605243181,0.8350980392156863,0.04175490196078435,0.7950980392156863,0.5971390297864673,0.03975490196078435&swatchOrder=0,1,2,3,4

main slide title
<h1></h1>

slide title
<h2></h2>

subtitle
<h3></h3>

paragraph
<p></p>

<blockquote>
</blockquote>
-->

  <!-- section class="fullscreen" data-background-iframe="./resources/map.html"></section-->
  <!-- section class="fullscreen" data-background-video=""></section-->
  <!-- section class="fullscreen" data-background-image=""></section-->
  <!--
  <section data-background="blue">
  <section data-background="yellow">
  <section data-background="green">
  <section data-background="#333333">
  -->

  <!--
  <section data-background="darkgreen">
    <section class="cover">
      <h2>
      </h2>
    </section>
    <section>
      <ul>
        <li>
        </li>
      </ul>
    </section>
  </section>
  -->

<div class="reveal">
<div class="slides">

  <section class="cover" data-background="blue">
    <h1>Resource Registry<br/>Demystified</h1>
    <br/>
    <footer>
      Johannes Raggam<br/>@ Plone Conference 2017, Barcelona
    </footer>
  </section>

  <section data-background="darkgreen">
    <section class="cover">
      <h2>Who am I</h2>
    </section>
    <section>
      <ul>
        <li>
Johannes Raggam
        </li>
        <li>
Graz / Austria
        </li>
      </ul>
    </section>
    <section>
      <ul>
        <li>
programmatic
        </li>
        <li>
BlueDynamics Alliance Memeber
        </li>
        <li>
Plone Framework Team Member
        </li>
      </ul>
    </section>
    <section>
      <ul>
        <li>
<a href="https://github.com/thet" target="_blank">https://github.com/thet</a>
        </li>
        <li>
<a href="https://twitter.com/thetetet" target="_blank">https://twitter.com/thetetet</a>
        </li>
        <li>
<a href="http://programmatic.pro/" target="_blank">http://programmatic.pro</a>
        </li>
      </ul>
    </section>
    <section>
      <ul>
        <li>
<a href="https://thet.github.io/talk-ploneconf2017" target="_blank">https://thet.github.io/talk-ploneconf2017</a>
        </li>
        <li>
<a href="https://github.com/thet/talk-ploneconf2017" target="_blank">https://github.com/thet/talk-ploneconf2017</a>
        </li>
      </ul>
    </section>
  </section>


  <section data-background="yellow">
    <section class="cover">
      <h2>
What is the resource registry?
      </h2>
    </section>
    <section>
      <ul>
        <li>
Register and deploy JS and CSS resources
        </li>
        <li>
Organize depenencies
        </li>
        <li>
Optimize resources and requests
        </li>
      </ul>
    </section>
    <section>
      <ul>
        <li>
Same purpose and goals in Plone 4 and 5
        </li>
      </ul>
    </section>
  </section>


  <section data-background="darkgreen">
    <section class="cover">
      <h2>
The resource registry in Plone 4
      </h2>
    </section>
    <section>
      SCREENSHOT
    </section>
    <section>
      <p>
Concatenation and minification in defined order
      </p>
    </section>
    <section>
      <h3>
Pros
      </h3>
      <ul>
        <li>
Simple architecture
        </li>
        <li>
Addons can easily register their resources
        </li>
        <li>
Resources are immediately available
        </li>
        <li>
Automatic cache management
        </li>
      </ul>
    </section>
    <section>
      <h3>
Cons
      </h3>
      <ul>
        <li>
No formally defined dependencies
        </li>
        <li>
Hard to manage dependencies
        </li>
        <li>
Hard to keep requests optimized
        </li>
      </ul>
    </section>
  </section>


  <section data-background="blue">
    <section class="cover">
      <h2>
The resource registry in Plone 5
      </h2>
    </section>
    <section>
      SCREENSHOT
    </section>
    <section>
      <p>
Based on plone.registry, RequireJS, LESS and gulp (CLI)
      </p>
    </section>
    <section>
      <h3>
Pros
      </h3>
      <ul>
        <li>
Formally defined dependencies
        </li>
        <li>
Easier to manage dependencies
        </li>
        <li>
Better CSS code organization
        </li>
        <li>
Better request optimization
        </li>
        <li>
Support for "legacy scripts" like in Plone 4
        </li>
        <li>
Automatic cache management
        </li>
      </ul>
    </section>
    <section>
      <h3>
Cons
      </h3>
      <ul>
        <li>
Precompiled bundles needed
        </li>
        <li>
Higher complexity
        </li>
        <li>
Hard to debug
        </li>
        <li>
Some technologies obsolete
        </li>
      </ul>
    </section>
    <section>
      <h3>
A praise for the resource registry
      </h3>
      <ul>
        <li>
It works quite well
        </li>
        <li>
A huge improvement for JS and CSS management
        </li>
        <li>
It's magic.
        </li>
      </ul>
    </section>
  </section>



  <section data-background="darkgreen">
    <section class="cover">
      <h2>
Resource and Bundle definitions
      </h2>
    </section>
    <section>
      <a href="https://github.com/plone/Products.CMFPlone/blob/master/Products/CMFPlone/interfaces/resources.py">Products.CMFPlone/Products/CMFPlone/interfaces/resources.py</a>
      <pre><code data-code="https://raw.githubusercontent.com/plone/Products.CMFPlone/master/Products/CMFPlone/interfaces/resources.py" data-trim></code></pre>
    </section>

    <section>
      <a href="https://github.com/plone/Products.CMFPlone/blob/master/Products/CMFPlone/profiles/dependencies/registry.xml">Products.CMFPlone/Products/CMFPlone/profiles/dependencies/registry.xml</a>
      <pre><code data-code="https://raw.githubusercontent.com/plone/Products.CMFPlone/master/Products/CMFPlone/profiles/dependencies/registry.xml" data-trim></code></pre>
    </section>

    <!-- require js config aequivalent -->
    <section>
      <a href="https://github.com/plone/mockup/blob/master/mockup/js/config.js">mockup/mockup/js/config.js</a>
      <pre><code data-code="https://raw.githubusercontent.com/plone/mockup/master/mockup/js/config.js" data-trim></code></pre>
    </section>

    <section>
      <a href="https://github.com/plone/mockup/blob/master/mockup/patterns/formautofocus/pattern.js">mockup/mockup/patterns/formautofocus/pattern.js</a>
      <pre><code data-code="https://raw.githubusercontent.com/plone/mockup/master/mockup/patterns/formautofocus/pattern.js" data-trim></code></pre>
    </section>

    <section>
      <a href="https://github.com/plone/Products.CMFPlone/blob/master/Products/CMFPlone/static/plone.js">Products.CMFPlone/Products/CMFPlone/static/plone.js</a>
      <pre><code data-code="https://raw.githubusercontent.com/plone/Products.CMFPlone/master/Products/CMFPlone/static/plone.js" data-trim></code></pre>
    </section>

    <section>
      <h3>legacy resources</h3>
      <pre><code data-trim>
<records prefix="plone.bundles/plone-legacy">
  <value key="compile">False</value>
</records>
      </code></pre>
    </section>
    <section>
      <a href="https://github.com/plone/Products.CMFPlone/blob/master/Products/CMFPlone/resources/browser/cook.py">Products.CMFPlone/Products/CMFPlone/resources/browser/cook.py</a>
      <pre><code data-code="https://raw.githubusercontent.com/plone/Products.CMFPlone/master/Products/CMFPlone/resources/browser/cook.py" data-trim></code></pre>
    </section>
    <section>
      <a href="https://github.com/plone/Products.CMFPlone/blob/master/Products/CMFPlone/resources/browser/scripts.pt">Products.CMFPlone/Products/CMFPlone/resources/browser/scripts.pt</a>
      <pre><code data-code="https://raw.githubusercontent.com/plone/Products.CMFPlone/master/Products/CMFPlone/resources/browser/scripts.pt" data-trim></code></pre>
    </section>

    <section>
      <h3>LESS variable expansion</h3>
    </section>
    <section>
      <a href="https://github.com/plone/Products.CMFPlone/blob/master/Products/CMFPlone/static/plone.less">Products.CMFPlone/Products/CMFPlone/static/plone.less</a>
      <pre><code data-code="https://raw.githubusercontent.com/plone/Products.CMFPlone/master/Products/CMFPlone/static/plone.less" data-trim></code></pre>
    </section>
    <section>
      <a href="https://github.com/plone/Products.CMFPlone/blob/master/Products/CMFPlone/resources/browser/mixins.py">Products.CMFPlone/Products/CMFPlone/resources/browser/mixins.py</a>
      <pre><code data-code="https://raw.githubusercontent.com/plone/Products.CMFPlone/master/Products/CMFPlone/resources/browser/mixins.py" data-trim></code></pre>
    </section>

  </section>



  <section data-background="darkgreen">
    <section class="cover">
      <h2>
Examples
      </h2>
    </section>

    <section>
      <h3>
Custom ``plone`` and ``plone-logged-in`` bundles
      </h3>
      <pre><code>
<?xml version="1.0"?>
<registry>

  <records prefix="plone.resources/plone" interface="Products.CMFPlone.interfaces.IResourceRegistry">
    <value key="js">++plone++myproject/plone.js</value>
    <value key="css">
      <element>++plone++myproject/plone.less</element>
    </value>
  </records>

  <records prefix="plone.bundles/plone" interface="Products.CMFPlone.interfaces.IBundleRegistry">
    <value key="jscompilation">++plone++myproject/plone-compiled.min.js</value>
    <value key="csscompilation">++plone++myproject/plone-compiled.min.css</value>
    <value key="resources">
      <element>plone</element>
    </value>
  </records>

</registry>
      </code></pre>
      <strong>Create empty stub resources first!</strong>
    </section>

    <section>
      <h3>
Immediate Plug and Play experience
      </h3>
      <a href="https://github.com/collective/collective.lazysizes/blob/master/src/collective/lazysizes/profiles/default/registry.xml">collective.lazysizes/src/collective/lazysizes/profiles/default/registry.xml</a>
      <pre><code data-code="https://raw.githubusercontent.com/collective/collective.lazysizes/master/src/collective/lazysizes/profiles/default/registry.xml" data-trim></code></pre>
    </section>

    <section>
      <h3>
Deploy resources only for specific pages
      </h3>
      <a href="https://github.com/plone/Products.CMFPlone/blob/master/Products/CMFPlone/resources/__init__.py">Products.CMFPlone/Products/CMFPlone/resources/__init__.py</a>
      <pre><code data-code="https://raw.githubusercontent.com/plone/Products.CMFPlone/master/Products/CMFPlone/resources/__init__.py" data-trim></code></pre>
    </section>
    <section>
      <pre><code data-trim>
# -*- coding: utf-8 -*-
from plone.tiles import Tile
from Products.CMFPlone.resources import add_bundle_on_request
from Products.CMFPlone.utils import get_top_request

class FilterTile(Tile):

    def __init__(self, context, request):
        top_request = get_top_request(request)
        add_bundle_on_request(top_request, 'aaf-jsapp')
      </code></pre>
    </section>

    <section>
      <h3>
Build a bundle
      </h3>
      <pre><code data-trim>
./bin/plone-compile-resources --help
usage: plone-compile-resources [-h] [-i INSTANCE] [-s SITE_ID] [-b BUNDLE]
                               [--compile-dir COMPILE_DIR] [-d BASE_DIR] [-G]
                               [-I] [-C]

Generate and setup Grunt infrastructure, then compile JS/LESS bundles for
Plone.

optional arguments:
  -h, --help            show this help message and exit
  -i INSTANCE, --instance INSTANCE
                        path to instance executable. If not provided, will
                        look in bin this was executed from for instance or
                        client1 (default: None)
  -s SITE_ID, --site-id SITE_ID
                        ID of the Plone site to fetch the configuration from.
                        Used only while Gruntfile generation. (default: Plone)
  -b BUNDLE, --bundle BUNDLE
                        Name of bundle to compile. Used while compile step.
                        (default: all)
  --compile-dir COMPILE_DIR
                        Output directory for the compiled bundle files. Used
                        only while Gruntfile generation. If not given the
                        directory is looked up from Plone registry. (default:
                        )
  -d BASE_DIR, --base-dir BASE_DIR
                        Base directory for this script (by default current
                        working directory). (default: .)
  -G, --skip-generate-gruntfile
                        Skip generation of Gruntfile.js (default: False)
  -I, --skip-npm-install
                        Skip npm install step (default: False)
  -C, --skip-compile    Skip compile step (running grunt) (default: False)
       </code></pre>
    </section>
    <section>
      <pre><code data-trim>
./bin/plone-compile-resources -b plone
      </code></pre>
    </section>
    <section>
      <strong>Add this to your buildout:</strong>
      <pre><code data-trim>
[buildout]
parts += compileresources

[compileresources]
recipe = zc.recipe.egg
eggs =
    ${buildout:eggs}
scripts =
    plone-compile-resources
      </code></pre>
    </section>

  </section>

  <section data-background="darkgreen">
    <section class="cover">
      <h2>
Future
      </h2>
    </section>
    <section>
      <h3>
Webpack
      </h3>
    </section>
    <section>
      <h3>
PLIP: Resource Registry Improvements
      </h3>
<a href="https://github.com/plone/Products.CMFPlone/issues/1955">PLIP 1955</a>
    </section>
    <section>
      <h3>
PLIP: Restructure CMFPlone static resources 
      </h3>
<a href="https://github.com/plone/Products.CMFPlone/issues/1653">PLIP 1653</a>
    </section>
  </section>

  <section data-background="#333333">
  <h1>Thank You!</h1>
  </section>

  <section data-background="darkgreen">
  <h1>Questions?</h1>
  </section>

</div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/3.5.0/lib/js/head.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/3.5.0/js/reveal.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<!--script src="./resources/libs/reveal.js/lib/js/head.min.js"></script>
<script src="./resources/libs/reveal.js/js/reveal.js"></script>
<script src="./resources/libs/jquery/dist/jquery.min.js"></script-->
<script src="./resources/init.js"></script>
</body>
</html>
